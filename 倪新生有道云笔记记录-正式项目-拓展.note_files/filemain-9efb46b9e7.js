function editor(e){"use strict";function t(){var e=getParameter("logLevel"),t=getParameter("debug");e&&(window.logLevel=e),t&&(window.DEBUG=!0),getUserOrAnonymous().then(function(e){window.loadFile=K,window.userInfo={userId:e.id,nickname:I||e.name,portraitUrl:e.photo},D=e.id||e.name,e.id||(L.text(e.name),Y.userPhoto.attr("src",e.photo),Y.nameBtn.hide(),U.on("click",function(){redirectToLogin(window.location.href)}),R.on("click",function(){z.val()&&(E._editor.updateNickname(z.val()),saveAnonymous(z.val(),e.photo),L.text(z.val()),G.hide())}),dropDownList(O,G),M.addClass("display-inline-block"),Y.accountBtn.addClass("display-inline-block")),n().then(function(){o()}),T()})}function n(){function e(){o.height(i.height()-163)}var t=$.Deferred(),n=P.find(".content-container"),o=$('<iframe id="content-body-editor" src="bulb.html"></iframe>').appendTo(n),i=$("body");return o.load(function(){X(o),e(),$(window).resize(e),E=o.contents().get(0).defaultView.editor,E.on("content-change",h).on("insert-link",s).on("insert-photo",u).on("insert-attachment",f).on("replace-image",u).on("replace-attachment",f).on("open-link",m).on("download-attachment",p).on("collabsession-change",q).on("datacommand-success",saveCommondLocal).on("session-closed",g).on("session-initialized",w).on("useraction-failed",v).on("context-menu",c).on("show-words",d),t.resolve()}),t.promise()}function o(){$.ajaxSetup({cache:!1}),getCollabNoteContent(K).done(function(e){var t=!isBulbNote(e.content);E.setContent(e.content,t)}).fail(function(e,t){console.error("Failed to load because of "+t),k(e)})}function i(e,t,n,o){function i(){r.hide(),c.unbind(),s.unbind()}var r=$(".show-alert-body"),a=r.find(".show-alert-title"),s=r.find(".show-alert-confirm"),c=r.find(".show-alert-cancel"),d=r.find(".show-alert-content");a.html(e),d.html(t),r.show(),o?c.show():c.hide(),n?s.show():s.hide(),c.on("click",function(){$.isFunction(o)&&o(),i()}),s.on("click",function(){$.isFunction(n)&&n(),i()})}function r(e,t){var n=$(".show-warn");clearTimeout(N),n.html(e),n.show(),t||(N=setTimeout(function(){n.hide()},3e3))}function a(e,t,n,o){function i(){c.remove()}function r(){$.isFunction(o)&&o(),i()}var a,s='<div class="popup"><div class="popup-content"> <div class="popup-header"> <span class="popup-title"></span> <span class="popup-close">X</span> </div> <div class="popup-inside-html"></div> <p><a class="popup-confirm popup-buttom-active">确定</a> <a class="popup-cancel popup-buttom-inact">取消</a></p> </div>',c=$(s).appendTo("body"),d=c.find(".popup-confirm"),l=c.find(".popup-cancel"),u=c.find(".popup-close"),f=(c.find(".popup-warn"),c.find(".popup-inside-html")),m=c.find(".popup-title");return m.html(e),f.html(t),a={$contentInside:f},n||d.hide(),o||l.hide(),c.show(),u.on("click",r),l.on("click",r),d.on("click",function(){$.isFunction(n)?n(a)&&i():i()}),c.on("keydown",function(e){switch(e.keyCode){case 13:d.click()}}),{hide:i}}function s(e){function t(t){var o,r=t.$contentInside.find(".popup-input");return o=r.val(),o.match(i)?(e(o),!0):(a(n,"您的输入链接格式有误！",!0,!1),!1)}var n="插入链接",o='<input class= "popup-input" type="text" value="http://">',i=new RegExp("(http[s]{0,1}|ftp)://[a-zA-Z0-9\\.\\-]+\\.([a-zA-Z]{2,4})(:\\d+)?(/[a-zA-Z0-9\\.\\-~!@#$%^&*+?:_/=<>]*)?","gi");a(n,o,t)}function c(e,t,n){var o,i,r=$("#content-body-editor").get(0),a=r.getBoundingClientRect(),s=a.left,c=a.top;o=_.chain(t).filter(function(e){return!(0!==e.type&&2!==e.type||e.isDisabled||e.isHidden)}).map(function(e){return{index:e.index,label:e.label,type:e.type}}).value(),i=j.open(o,e.left+s,e.top+c,n),i.on("resize",function(){var t=r.getBoundingClientRect();i.css({left:e.left+t.left+"px",top:e.top+t.top+"px"})})}function d(e){a("字数统计","总计字数："+e)}function l(e,t){function n(){function e(){o.abort()}var n=new FormData,m=u[0].files;if(u.unbind(),0!==m.length){if(m[0].size>s)return void a("上传","暂时不支持大于25M的文件。",!0,!1);if(1===i&&!d.test(m[0].name)||2===i&&c.test(m[0].name))return void a("上传","暂时不支持该上传类型。",!0,!1);n.append("file",u[0].files[0]),n.append("type",i),o=uploadFile(K,i),o.addEventListener("loadstart",function(){r=a(l,f,!1,e)},!1),o.upload.addEventListener("progress",function(e){if(e.lengthComputable){var t=Math.round(100*e.loaded/e.total);$(".upload-progeress-line").width(t+"%"),console.log(t)}},!1),o.addEventListener("load",function(e){var n=JSON.parse(e.target.responseText);return o.status>=400?(a("上传","上传失败，请稍后重试。",!0,!1),void r.hide()):(t(1===i?n.url:{src:n.src,resource:n.url,fileName:n.fileName,fileLength:n.sz}),void r.hide())},!1),o.upload.addEventListener("error",function(e){a("上传","上传失败，请稍后重试。",!0,!1),r.hide()},!1),o.addEventListener("abort",function(e){},!1),o.send(n)}}var o,i,r,s=26214400,c=/^.+\.(exe|com|sys|cmd|bat)$/i,d=/^.+\.(png|jpeg|jpg|gif|bmp)$/i,l="上传进度",u=$("#editor-upload"),f='<div class="upload-progress"><div class="upload-progeress-line"></div></div> ';u.val(""),"image"===e&&(u.attr("accept","image/*"),i=1),"attachment"===e&&(u.attr("accept","*"),i=2),u.click(),u.on("change",n)}function u(e){l("image",e)}function f(e){l("attachment",e)}function m(e){window.open(e)}function p(e,t){var n=document.createElement("a");n.setAttribute("href",e),n.setAttribute("download",t),n.click()}function h(e){}function g(e){r("编辑出现错误，同步内容失败。您需要刷新当前页面重新进行协同编辑。刷新后未保存的更改会丢失，请提前将内容拷贝。",!0)}function v(e){r(e)}function w(e,t){var n;e?(Y.loadEl.hide(),n=function(){b(),setTimeout(n,2e4)},setTimeout(n,2e4),window.onbeforeunload=y,S=E.getNoteVersion()):window.location.href="index.html?id="+K+"&type=note&error=true&errorc="+t}function b(){var e=E.getNoteVersion();if(e===S||isCommandListEmpty())return void console.log("版本号相同或无命令操作，不向serve存储数据");var t=E.getContent(!1);B.text("正在保存..."),saveCommand(K,D,e,k).fail(function(e){k(e)}),saveCollabNote(K,t,E.getNoteVersion()).then(function(){B.text("已在"+getTime()+"保存"),S=e,console.log("正在存储命令和内容到serve"+e)}).fail(function(e){k(e)})}function y(){return E.getNoteVersion()===S||isCommandListEmpty()?void 0:(b(),"协同编辑的内容还未保存，请您回到页面确认保存完成后，再关闭此页面！")}function x(){window.location.href=window.location.href}function k(e){e.responseJSON&&"51208"===e.responseJSON.error&&i("笔记状态改变","该笔记权限已停止分享，暂时无法编辑。如果您关闭或刷新该页面，未保存的更改可能会丢失，请提前将内容拷贝。",!0,!1)}function T(){var e,t,n=["P_INFO","S_INFO","YNOTE_LOGIN"],o=[];for(t=0;t<n.length;t++)o.push(cookies.get(n[t]));e=setInterval(function(){var e=[];for(t=0;t<n.length;t++)e.push(cookies.get(n[t]));_.isEqual(e,o)||(o=e,x())},1e3)}function C(){var e,t;$(document).ajaxError(function(n,o){0===o.status&&void 0===e&&(i("网络提醒","网络中断，暂时无法编辑，请在网络恢复后尝试。",!0),t=setInterval(function(){isShare()},1e3),e=0)}),$(document).ajaxComplete(function(n,o){0!==o.status&&0===e&&(i("网络提醒","网络恢复了，请刷新页面。刷新页面可能丢失未保存信息。",x,!1),e=void 0,clearInterval(t))})}var E,I,S,D,N,P=$(".share-content"),A=$("#main-mask"),F=$("#pwd-dialog"),M=$(".anonymous-name"),L=M.find(".anonymous-name-text"),U=M.find(".anonymous-name-login"),O=M.find(".anonymous-name-change"),G=$(".change-name-drop"),R=G.find(".drop-buttom"),z=G.find("input"),B=$("#lstime"),j=menuProvider(),X=e.renderNote,H=e.hasPwd,K=e.shareKey,Y=e.allEl,q=function(){function e(e,t,n,o){this.name=e,this.color=t,this.id=n,this.portrait=o}function t(t){var i=_.chain(t).toArray().reduce(function(t,n){return t.push(new e(n.nickname,n.lockColor,n.sessionId,n.portraitUrl)),t},[]).value();o.empty().append(n({userlist:i})),o.find("#attendee-list").on("click",function(e){e.stopPropagation()}),o.show()}var n=$.templates("#attendee-tmpl"),o=$("#attendee-dialog");return o.on("click",function(e){$(this).toggleClass("show"),e.stopPropagation()}),t}();C(),H?(Y.loadEl.hide(),A.show(),F.show().submit(function(e){var n=F.find("input:first"),o=n.val();e.preventDefault(),Y.loadEl.show(),checkCollabPwd(K,o).then(function(){t(),F.hide(),A.hide()},function(){Y.loadEl.hide(),F.addClass("error"),n.on("focus",function(){F.removeClass("error"),n.val(""),n.off("focus")})})})):t()}function getTime(){var e=new Date,t=e.getMinutes();return e.getHours()+":"+(t>0&&10>t?"0"+t:""+t)}function menuProvider(){function e(){o&&o.remove(),o=null,window.onMenuItem=null,$(window).off("resize",r)}function t(t,i,a,s){var c,d=[];for(e(),c=0;c<t.length;c++)if(d.push(t[c]),2===t[c].type)for(;c<t.length&&2===t[c].type;)c++;return 2===d[0].type&&d.shift(),2===_.last(d).type&&d.pop(),o=$(n({items:d,left:i,top:a})).appendTo(document.body),$(window).on("resize",r),s&&(window.onMenuItem=s),o}var n=$.templates("#menu-tmpl"),o=null,i=window.hideFunc,r=_.debounce(function(){o&&o.trigger("resize")},30);return window.hideFunc=function(){i(),e()},{open:t}}function redirectToLogin(e){detectmob()?window.location.href="https://note.youdao.com/oauth/login_mobile.html?back_url="+e:window.location.href="https://note.youdao.com/signIn/group.html?&callback="+e}function reConstructMeta(e){var t,n,o,i;return 0==e.isMultilevel?(e.entry&&e.entry.entryPath&&(t=e.entry.entryPath,n=t.split("/"),1===n.length?o=n[0]:(o=n[n.length-1],i=n[n.length-2])),{id:o,name:e.name,domain:0,modifyTime:1e3*e.entry.modifyTimeForSort,createTime:1e3*e.entry.createTimeForSort,lastUpdateTime:1e3*e.entry.modifyTimeForSort,version:e.entry.version,dir:e.entry.directory,size:0,parentId:i,readTimes:void 0,praiseTimes:void 0,description:void 0,thumbImage:void 0,isFromOld:!0,coopEdit:e.isCoopEdit,hasPwd:e.sharePassword}):e.isMultilevel&&1==e.isMultilevel?{id:e.entry.id,name:e.entry.name,domain:e.entry.domain,modifyTime:1e3*e.entry.modifyTimeForSort,createTime:1e3*e.entry.createTime,lastUpdateTime:1e3*e.entry.lastUpdateTime,version:e.entry.version,dir:e.entry.dir||e.entry.directory,size:e.entry.fileSize,parentId:e.entry.parentId,readTimes:0,praiseTimes:0,description:void 0,thumbImage:void 0,isFromOld:!1,coopEdit:e.isCoopEdit,hasPwd:e.sharePassword}:void 0}function getFileMeta(e,t){var n=$.Deferred();return $.ajax({type:"GET",url:"/yws/api/personal/share?method=get",data:{shareKey:e,fileId:t},success:function(e){n.resolve(reConstructMeta(e))},error:function(e){n.reject(e)}}),n.promise()}function getNoteContent(e,t){var n,o="/yws/public/note/";return n=t?o+e+"/"+t:o+e,$.get(n)}function reConstructNotebook(e){for(var t,n,o,i,r,a=e[2],s=[],c=0;c<a.length;c++)a[c].p&&(t=a[c].p,n=t.split("/"),1===n.length?o=n[0]:(o=n[n.length-1],i=n[n.length-2])),r={id:o,name:0!=a[c].dr||/\./.test(a[c].tl)?a[c].tl:a[c].tl+".note",domain:a[c].domain||0,modifyTime:1e3*a[c].mt,createTime:1e3*a[c].ct,lastUpdateTime:1e3*a[c].mt,version:a[c].v,dir:1===a[c].dr,size:a[c].sz,parentId:i,readTimes:a[c].pv,praiseTimes:a[c].favorite,description:a[c].pp.dg||void 0,thumbImage:a[c].pp.thmurl||void 0,accessoryNum:a[c].pp.resnum||void 0},s.push(r);return{id:e[3],name:e[1],domain:-1,modifyTime:0,createTime:0,lastUpdateTime:0,version:-1,dir:!0,size:0,childrenNum:e[0],children:s,parentId:void 0,readTimes:0,praiseTimes:0,description:void 0,thumbImage:void 0}}function getNotebookContent(e,t){var n=$.Deferred(),o="/yws/public/notebook/",i=t?o+e+"/subdir/"+t:o+e;return $.ajax({type:"GET",url:i,success:function(e){n.resolve(reConstructNotebook(e))},error:function(e){n.reject(e)}}),n.promise()}function getFilePath(e,t){return $.get("/yws/public/notebook/"+e+"/getPath/"+t)}function getChildrenFolders(e){return $.get("/yws/api/personal/share/subdirs",{fileId:e})}function getCurrentUserInfo(){return $.get("/yws/api/self",{method:"get"})}function praiseClick(e,t){var n="/yws/public/note/"+e,o=t?n+"/"+t:n;return $.post(o,{method:"praise"})}function saveToNote(e,t,n){return $.post("/yws/api/personal/share",{method:"copy",shareKey:e,fileId:t,parentId:n})}function saveNotebook(e,t){return $.post("/yws/api/personal/share",{method:"copyDir",shareKey:e,parentId:t})}function getDownloadLink(e,t){return"/yws/api/personal/file/"+t+"?method=download&shareKey="+e}function getPreviewLink(e,t){return"/yws/api/personal/preview/"+t+"?method=convert&&shareToken="+e}function getJubaoLink(e,t,n){return"/jubao?shareKey="+e+"&fid="+t+"&type="+n}function isYDocUser(e){return $.get("/yws/api/personal/user?method=check",{userId:e})}function isXuebaNote(e){return $.post("/yws/mapi/xueba?method=getNote",{shareKey:e})}function saveXuebaNote(e,t,n){return $.post("/yws/mapi/xueba?method=getNote",{shareKey:e,path:t,clientUniqString:n})}function saveXuebaNotebook(e,t,n){return $.post("/yws/mapi/xueba?method=getNote",{shareKey:e,path:t,clientUniqString:n,isNote:!1})}function getCollabNoteContent(e,t,n){return $.get("/yws/public/collaboration/"+e+"?method=getNote")}function saveCollabNote(e,t,n){return $.post("/yws/public/collaboration/"+e+"?method=saveNote",{content:t,coopVersion:n})}function isShare(e){var t=$.Deferred();return $.get("/yws/public/collaboration/note?method=queryNoteState",{shareKey:e}).done(function(e){switch(e.notestate){case 4:t.resolve();break;default:t.resolve()}}),t.promise()}function saveAnonymous(e,t){lStorage.set(ANAME,e),lStorage.set(APHOTO,t)}function requestAnonymous(){var e=$.Deferred();return $.get("/yws/public/collaboration/note?method=getNickName").then(function(t){e.resolve({name:t.nickName,photo:t.photoUrl})}),e.promise()}function getUserOrAnonymous(e){var t=$.Deferred();return YnoteLogin.check(function(e){e?getCurrentUserInfo().then(function(e){t.resolve({name:e.name,photo:e.photo,id:e.userId}),saveAnonymous("","")}):lStorage.get(ANAME)&&lStorage.get(APHOTO)?t.resolve({name:lStorage.get(ANAME),photo:lStorage.get(APHOTO)}):requestAnonymous().done(function(e){t.resolve(e),saveAnonymous(e.name,e.photo)})}),t.promise()}function uploadFile(e,t){var n=new XMLHttpRequest;return n.open("post","/yws/public/collaboration/"+e+"?method=putres&type="+t),n}function getDefaultFolder(){return $.get("/yws/api/personal/share?method=getDefaultFolder")}function checkCollabPwd(e,t){var n=$.Deferred();return $.get("/yws/public/collaboration/note/"+e+"?method=checkPassword",{password:t}).then(function(e){"true"===e.res?n.resolve():n.reject()},function(){n.reject()}),n.promise()}function getParameter(e){var t,n,o=window.location.search.substring(1),i=o.split("&");for(t=0;t<i.length;t++)if(n=i[t].split("="),n[0]===e)return n[1];return null}function getTimeString(e){var t=e.getMonth()<9?"0"+(e.getMonth()+1):e.getMonth()+1,n=e.getDate()<10?"0"+e.getDate():e.getDate(),o=[e.getFullYear(),t,n].join("-");return o}function getSizeString(e){var t=["字节","KB","MB","GB","TB"],n=0;for(e=e||0;e>=1024&&3>n;)n++,e/=1024;return String(Math.floor(100*e)/100)+" "+t[n]}function getIcon(e,t){return 0===e.domain?"file-icon-"+t+"-note":getIconClass(e.name||e.tl,t)}function getIconClass(e,t){var n=e.toLowerCase().split("."),o=n[n.length-1],i="file-icon";return t&&(i=i+"-"+t),i+"-"+({table:"table",pdf:"pdf",txt:"txt",text:"txt",doc:"word",docx:"word",rtf:"word",excel:"excel",xls:"excel",xlsx:"excel",csv:"excel",ppt:"ppt",pps:"ppt",pptx:"ppt",ppsx:"ppt",flash:"flash",swf:"flash",flv:"flash",compress:"compress",zip:"compress",rar:"compress","7z":"compress",html:"html",htm:"html",mht:"html",audio:"audio",mp3:"audio",aac:"audio",ogg:"audio",wav:"audio",flac:"audio",m4a:"audio",ape:"audio",wma:"audio",video:"video",rm:"video",rmvb:"video",avi:"video",mkv:"video",mpg:"video",mpeg:"video",wmv:"video",ts:"video",m4v:"video",mp4:"video",image:"image",jpg:"image",jpeg:"image",gif:"image",png:"image",bmp:"image",psd:"image"}[o]||"other")}function detectmob(){return navigator.userAgent.match(/Android/i)||navigator.userAgent.match(/webOS/i)||navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)||navigator.userAgent.match(/BlackBerry/i)||navigator.userAgent.match(/Windows Phone/i)}function loadIframe(e,t){return window.frames[e]?(window.frames[e].location=t,!1):!0}function isWebkit(){return/applewebkit/i.test(navigator.userAgent)}function isIOS(){return navigator.userAgent.match(/iPhone/i)||navigator.userAgent.match(/iPad/i)}function isWeixin(){var e=window.navigator.userAgent.toLowerCase();return"micromessenger"==e.match(/MicroMessenger/i)?!0:!1}function countLength(e){if(!e)return 0;var t=e.match(/[^\x00-\xff]/gi);return e.length+(null===t?0:t.length)}function cut(e,t){var n,o=0,i="";if(!e)return e;if(t=Number(t),e=e.replace(/\n/g,""),e=e.replace(/\r/g,""),countLength(e)>t){for(n=0;n<e.length&&(/[^\x00-\xff]/gi.test(e[n])?o+=2:o++,!(o>t));n++)i+=e[n];return i+"..."}return e}function redirectToMobile(e,t,n){var o="/share/mobile/?id="+e+"&type="+t,i=n?o+"&fileId="+n:o;return detectmob()?void(window.location.href=i):void 0}function redirectToWeb(e,t,n){var o="/share/web/?id="+e+"&type="+t,i=n?o+"&fileId="+n:o;return detectmob()?void 0:void(window.location.href=i)}function alert(e){function t(){d.unbind(),l.unbind(),u.unbind()}function n(){t(),r.hide()}function o(){d.click(n),l.click(function(e){f.resolve(),n()}),u.click(n)}var i=window.innerHeight,r=$("#alert"),a=$("#dialogoverlay"),s=$("#dialogtitle"),c=$("#dialogbody"),d=($("#dialogfoot"),$(".close_icon")),l=$("#ok"),u=$("#cancel"),f=$.Deferred();return a.css("display","block"),a.css("height",i+"px"),s.text(e.title),c.text(e.content),o(),r.show(),f.promise()}function getIdFromPath(e){var t=e.split("/");return t[t.length-1]}function parse(e){var t;return".note"==e&&(e="无标题笔记.note"),(e||""==e)&&(t=e.replace(new RegExp("&","g"),"&amp;").replace(new RegExp('"',"g"),"&quot;").replace(new RegExp("<","g"),"&lt;").replace(new RegExp(">","g"),"&gt;").replace(new RegExp(" ","g"),"&nbsp;").replace(new RegExp("'","g"),"&quot;")),t}function parseContent(e,t){function n(e){var t={};return["createtime","modifytime","start","end","content","subject","type","interval","remind","checked","notifiers"].forEach(function(n){var o=e.attr("data-attr-"+n);t[n]=o?o.trim():"","false"===t[n]&&(t[n]=!1)}),t.id=e.attr("data-res-todo"),""===t.title&&(t.title="无内容提醒"),t}function o(t){var o=n(t);t.replaceWith(e.render(o))}var i=$("<div></div>").append(t),r=i.find("input[data-media-type=todo]");return r.each(function(e,t){o($(t))}),i.html()}function tableScroll(e){function t(e){var t='<div class="table-scroll">'+e[0].outerHTML+"</div>";e.replaceWith(t)}var n=$("<div></div>").append(e),o=n.find("table");return o.each(function(e,n){t($(n))}),n.html()}function encodeTime(e,t){for(var n=e%1e12,o=n.toString(),i=[],r=0;r<o.length;r++){var a="A",s=String.fromCharCode(o.charAt(r)-"0"+a.charCodeAt(0));for(var c in t)s==c&&(i[r]=t[c])}return i.join("")}function encodeArray(e,t,n){for(var o=new Array(4),i=(t+n)%o.length,r=t+o.length,a=t;r>a;a++)o[i++%o.length]=e[a];for(var s=t;r>s;s++)e[s]=o[s-t]}function clientUniqStringProduce(e){var t=encodeTime(e,CLIENT_ENCODE_MAP),n=[];n[0]=parseInt(1e4*Math.random()),n[1]=parseInt(1e4*Math.random()),n[2]=parseInt(1e4*Math.random());var o=t.split("");encodeArray(o,0,n[0]),encodeArray(o,4,n[1]),encodeArray(o,8,n[2]);for(var i="",r=0;3>r;r++){i+=n[r];for(var a=0;4>a;a++)i+=o[4*r+a]}return i}function isBulbNote(e){if(!e)return!1;var t=new DOMParser,n=$(t.parseFromString(e,"text/xml"));return n.find("note[xmlns]").length>0}function filterNoteSuffix(e){if(!_.isNull(e)){var t=e.split(/\./),n="";if(t.length<=1)return e;for(var o=0;o<t.length-1;o++)0==o?n+=t[o]:n=n+"."+t[o];return""==n&&(n="无标题笔记"),n}}function dropDownList(e,t){e.on("click",function(e){t.toggle(),e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0,t.on("click",function(e){e&&e.stopPropagation?e.stopPropagation():window.event.cancelBubble=!0})})}function comparator(e,t){function n(e,t){return e.isFolder&&!t.isFolder?-1:!e.isFolder&&t.isFolder?1:0}function o(e,t,n){return/[^\x00-\xff]/gi.test(e.name[n])&&!/[^\x00-\xff]/gi.test(t.name[n])?1:!/[^\x00-\xff]/gi.test(e.name[n])&&/[^\x00-\xff]/gi.test(t.name[n])?-1:e.name[n].toLowerCase().localeCompare(t.name[n].toLowerCase())}function i(e,t){for(var n,i=e.name.length<t.name.length?e.name.length:t.name.length,r=0;i>r;r++)if(n=o(e,t,r),0!=n)return n;return 0}function r(e,t){var n=!1,o=!1;return/[^\x00-\xff]/gi.test(e.name)||(n=!0),/[^\x00-\xff]/gi.test(t.name)||(o=!0),n&&o?0:i(e,t)}var a=n(e,t);if(0!==a)return a;var s;return s=r(e,t),0!=s?s:e.name.toLowerCase().localeCompare(t.name.toLowerCase())}function File(e,t,n,o,i){return{id:String(e.id),name:String(parse(e.name||"")),nameForShow:0!==e.domain?String(parse(e.name||"")):String(parse(filterNoteSuffix(e.name||""))),originalName:".note"!==e.name?String(e.name):String("无标题笔记.note"),modifyTime:getTimeString(e.modifyTime?new Date(e.modifyTime):new Date(e.lastUpdateTime)),createTime:getTimeString(new Date(e.createTime||0)),domain:Number(e.domain),version:Number(e.version||-1),isFolder:e.dir,size:getSizeString(e.size||0),iconClass:getIcon(e,"small"),largeIconClass:getIcon(e,"large"),bigIconClass:getIcon(e,"big"),isOffice:1==e.domain&&REGEXMAP.OFFICE.test(e.name),isDownload:1==e.domain&&!REGEXMAP.OFFICE.test(e.name),downloadLink:1==e.domain?getDownloadLink(t,e.id):void 0,previewLink:1==e.domain&&(REGEXMAP.PDF.test(e.name)||REGEXMAP.TXT.test(e.name))?"preview.html?id="+t+"&fileId="+e.id:void 0,ableToPreview:0==e.domain||2==e.domain||1==e.domain&&(REGEXMAP.PDF.test(e.name)||REGEXMAP.TXT.test(e.name)),isImage:REGEXMAP.IMAGE.test(e.name),isRootFolder:e.id==n,parentId:String(e.parentId),readTimes:Number(e.readTimes||0),praiseTimes:Number(e.praiseTimes||0),description:_.isUndefined(e.description)||""===e.description||_.isUndefined(e.thumbImage)?String(parse(cut(e.description,90))):String(parse(cut(e.description,50))),thumbImage:e.thumbImage,hasDescription:!_.isUndefined(e.description)&&""!==e.description,hasThumb:!_.isUndefined(e.thumbImage)&&!_.isNull(e.thumbImage),jubaoLink:getJubaoLink(t,e.id,o),sharedByYDoc:i}}function StackFile(e,t){return{id:String(e.fileId?e.fileId:e.id),name:String(parse(e.name||"")),isRootFolder:Boolean(e.fileId?e.fileId==t:e.id==t)}}function PathFile(e,t){return{id:String(e.id),name:String(parse(e.name||"")),hasChildDir:e.hasChildDir,isRootFolder:t}}cookies=function(){"use strict";function e(e){var t=new RegExp("(^| )"+e+"=([^;]*)(;|$)"),n=document.cookie.match(t);return null===n?null:n[2]}function t(e,t,n){null===t&&(n=new Date,n.setTime(n.getTime()-1),document.cookie=e+"="+t+";expires="+n.toGMTString())}function n(){return document.cookie}return{get:e,set:t,string:n}}(),lStorage=function(){var e;try{e=window.localStorage}catch(t){}if(e)return{get:function(t){var n=e.getItem(t);return n?unescape(n):null},set:function(t,n,o){e.setItem(t,escape(n))},del:function(t){e.removeItem(t)},clear:function(){e.clear()},getAll:function(){var t,n=e.length,o=null,i=[];for(t=0;n>t;t++)o=e.key(t),i.push(o+"="+this.getKey(o));return i.join("; ")}};if(window.ActiveXObject){var n=document.documentElement,o="localstorage";try{n.addBehavior("#default#userdata"),n.save("localstorage")}catch(t){}return{set:function(e,t){n.setAttribute(e,t),n.save(o)},get:function(e){return n.load(o),n.getAttribute(e)},del:function(e){n.removeAttribute(e),n.save(o)}}}return{get:function(e){var t,n=document.cookie.split("; "),o=n.length,i=[];for(t=0;o>t;t++)if(i=n[t].split("="),e===i[0])return unescape(i[1]);return null},set:function(e,t,n){n=new Date,n.setDate(n.getDate()+1),document.cookie=e+"="+escape(t)+"; expires="+n.toGMTString()},del:function(e){document.cookie=e+"=''; expires=Fri, 31 Dec 1999 23:59:59 GMT;"},clear:function(){var e,t=document.cookie.split("; "),n=t.length,o=[];for(e=0;n>e;e++)o=t[e].split("="),this.deleteKey(o[0])},getAll:function(){return unescape(document.cookie.toString())}}}();var YnoteLogin={check:function(e){var t=this;$.get("/login/acc/pe/getsess?product=YNOTE",{product:"YNOTE",_:(new Date).getTime()}).always(function(){t.changeUrsCookie(e)})},changeUrsCookie:function(e){var t=this;$.get("/auth/urs/login.json",{app:"web",_:(new Date).getTime()}).done(function(n){n.login&&$.isFunction(e)?e.call(this,!0):t.checkcq(e)})},checkcq:function(e){$.getJSON("/auth/cq.json",{app:"web",_:(new Date).getTime()}).done(function(t){t.user&&t.user.login&&$.isFunction(e)?e.call(this,!0):e.call(this,!1)})}},ANAME="anonymousUserName",APHOTO="anonymousUserImg";!function(){var e=[];window.saveCommondLocal=function(t){e.push(t)},window.saveCommand=function(t,n,o){var i=$.Deferred(),r="["+e.join(",")+"]";return $.post("/yws/public/collaboration/note/"+t+"?method=saveCommand",{coopVersion:o,userId:n,commandStr:r}).then(function(){e=[],i.resolve()},function(e){i.reject(e)}),i.promise()},window.isCommandListEmpty=function(){return 0===e.length}}();var REGEXMAP={IMAGE:/^.*(\.png|\.jpg|\.jpeg|\.gif|\.bmp)$/i,NOTE:/.+\.note$/,OFFICE:/^.*\.(doc|docx|ppt|pptx|xls|xlsx)$/i,PDF:/^.*\.(pdf)$/i,TXT:/^.*\.(txt|text)$/i,TABLE:/^.*\.(table)$/i,EXCEL:/^.*\.(xls|xlsx)$/i},DISBTN="disable",CLIENT_ENCODE_MAP={A:"C",B:"B",C:"J",D:"O",E:"U",F:"P",G:"D",H:"G",I:"I",J:"A",K:"W",L:"X",M:"N",N:"F",O:"T",P:"S",Q:"E",R:"H",S:"M",T:"Z",U:"L",V:"Y",W:"K",X:"V",Y:"Q",Z:"R"},GUID=function(){var e;return e={newGUID:function(){this.date=new Date;for(var e="",t=this.hexadecimal(this.getGUIDDate(),16),n=this.hexadecimal(this.getGUIDTime(),16),o=0;9>o;o++)e+=Math.floor(16*Math.random()).toString(16);for(e+=t,e+=n;e.length<32;)e+=Math.floor(16*Math.random()).toString(16);return this.formatGUID(e)},getGUIDDate:function(){return this.date.getFullYear()+this.addZero(this.date.getMonth()+1)+this.addZero(this.date.getDay())},getGUIDTime:function(){return this.addZero(this.date.getHours())+this.addZero(this.date.getMinutes())+this.addZero(this.date.getSeconds())+this.addZero(parseInt(this.date.getMilliseconds()/10))},addZero:function(e){return"NaN"!==Number(e).toString()&&e>=0&&10>e?"0"+Math.floor(e):e.toString()},hexadecimal:function(e,t,n){return void 0!==n?parseInt(e.toString(),n).toString(t):parseInt(e.toString()).toString(t)},formatGUID:function(e){var t=e.slice(0,8)+"-",n=e.slice(8,12)+"-",o=e.slice(12,16)+"-",i=e.slice(16,20)+"-",r=e.slice(20);return t+n+o+i+r}},{newGUID:function(){return e.newGUID()},isValid:function(e){var t=["null","undefined"];return e&&-1==t.indexOf(e+"")}}}();$(function(){"use strict";function e(){$("html").is(".underie8")?window.location.href="index.html?error=true":$("html").is(".ie8")&&(b=!0)}function t(){var e,t,o=$("body").outerHeight(),i=o-O.outerHeight()-30;if($("#main-container").height(i),m&&($("#main").css("min-height",i+"px"),b)){var r=c.parent().parent(),a=r.find(".content-header");c.height(r.parent().innerHeight()-a.outerHeight()-65)}if(p){var r=c.parent().parent(),a=r.find(".content-header");c.height(i-a.outerHeight()-65)}l&&(e=$("#main"),t=$("#img-download"),z?t.height()<i-200&&e.height(i-50):(e.height(i-50),l.height(i-200))),n()}function n(){if($("#save").length>0){var e=$("#save"),t=$("body").height();e.height()+195>t?e.css("top",80-(e.height()+195-t)+"px"):e.css("top","80px")}}function o(e){h.addClass("show");var t="preview.html?id="+X+"&type="+H+"&fileId="+e;h.attr("href",t),h.attr("target","_blank"),h.show()}function i(){window.yd_slot_id=B,j.find(".ad").attr("id","yd_slot_id_"+B),setTimeout(function(){var e=document.createElement("script");e.src="http://impservice.union.youdao.com/imp/js/commonAd.js",j.append(e)},100)}function r(e){function t(){$("#note-save").hide()}function o(){$(".save-mask").show()}function i(){$(".save-mask").hide()}function r(e,n){C.addClass(DISBTN),o(),$(".btn-ok").addClass(DISBTN),saveToNote(X,e,n).then(function(){E.text("保存成功，请稍后查看。"),C.removeClass(DISBTN),Y&&window._hmt.push(["_trackEvent","marketPush","mp-saveSuccess","mp-saveSuccess-"+X])},function(e){e=e.responseJSON,e&&"401"===e.error?E.text("您不是有道云笔记会员，无法保存附件超过25M的笔记"):e&&"210"===e.error?E.text("笔记空间已满，保存失败"):e&&"225"===e.error?E.text("保存失败，目标文件夹已不存在。"):E.text("保存失败"),C.removeClass(DISBTN)}).always(function(){E.show(),$(".btn-ok").removeClass(DISBTN),i(),setTimeout(function(){E.hide()},5e3),t()})}function a(){function a(){function e(e){e.stopPropagation();var t=$(e.currentTarget.parentElement),n=t.find(".save-detail-folder-name").text(),o=$("#selected");c=t.data("id"),(g||0!==c)&&(o.text(n),o.prop("title",n),u[c]&&(v=p.render(u[c]),$(".selected-path").html(v)),a())}var t=$(".expand-area"),r=$(".save-detail-folder"),s=$(".save-detail-folder-name");t.unbind(),r.unbind(),s.unbind(),t.one("click",function(e){e.stopPropagation();var t,r=0==$(e.currentTarget).data("id")?void 0:$(e.currentTarget).data("id"),s=e.currentTarget.parentElement;if($(s).hasClass("expanded")){var c=$(s.nextElementSibling||s.nextSibling);c.empty(),$(s).removeClass("expanded"),n(),a()}else o(),getChildrenFolders(r).then(function(e){var o,c=[];r=r||0,t=$(s).find(".save-detail-folder-name"),$(s).addClass("expanded");for(o in e)e.hasOwnProperty(o)&&e[o]&&(c.push(new PathFile({id:o,name:e[o].name,hasChildDir:e[o].hasChildDir})),_.isUndefined(u[o.toString()])&&(u[o.toString()]=u[r.toString()].concat(new PathFile({id:o,name:e[o].name,hasChildDir:e[o].hasChildDir}))));if(_.findWhere(c,{id:r}))return a(),i(),void n();if(s.nextElementSibling||s.nextSibling){var d=$(s.nextElementSibling||s.nextSibling);v=m.render(c.sort(comparator)),d.html(v),a(),i(),n()}},function(e){i()})}),r.one("click",e),s.one("click",e)}function s(){v=f.render({selectedFolderName:d,defaultFolder:d}),l.html(v),l.show(),n(),$("#modify").one("click",function(){var e=[],t={id:0,name:"全部文件",hasChildDir:!0};e.push(t),u[t.id.toString()]=[new PathFile(t,!0)],v=m.render(e);var n=$("#save-path-select");n.html(v),n.show(),a(),$(".expand-area").click()}),$(".close").click(t),$(".btn-cancel").click(t),$(".btn-ok").click(function(){t(),r(e.id,c)})}var c,d,l=$("#note-save"),u={},f=$.templates("#savePathTmpl"),m=$.templates("#pathDetailTmpl"),p=$.templates("#pathTextTmpl");g?(d="我的资源",s()):(d="默认笔记本",getDefaultFolder().then(function(e){d=e.name,s()},function(){d="默认笔记本",s()}))}function s(){var e=encodeURIComponent(window.location.href+"#auto");Y&&window._hmt.push(["_trackEvent","marketPush","mp-login","mp-login-"+X]),redirectToLogin(e)}function c(){window._hmt.push(["_trackEvent","web","save-to-note"]),Y&&window._hmt.push(["_trackEvent","marketPush","mp-saveClick","mp-saveClick-"+X]),YnoteLogin.check(function(e){e?a():s()})}$(".save-to-note").click(function(){if(0===e.domain){if($(this).hasClass(DISBTN))return;_.isUndefined(g)?getCurrentUserInfo().then(function(e){w=!0,isYDocUser(e.userId).then(function(e){g=e.result,c()},function(){c()})},function(){c()}):c()}else w===!1?s():_.isUndefined(g)?getCurrentUserInfo().then(function(e){w=!0,isYDocUser(e.userId).then(function(e){g=e.result,g?c():alert({title:"保存提示",content:"由于您的笔记客户端版本太低，无法完成保存，请下载并安装最新客户端后再试"})})}):g?c():alert({title:"保存提示",content:"由于您的笔记客户端版本太低，无法完成保存，请下载并安装最新客户端后再试"})})}function a(e){e.find("img").each(function(e,t){var n=$(t),o=n.attr("path");o&&(n.addClass("attachment"),n.click(function(){window.location=o}))})}function s(){window.hideFunc=function(){R.hide(),$("#attendee-dialog").removeClass("show")},$(document).on("click",function(){window.hideFunc()})}var c,d,l,u,f,m,p,h,g,v,w,b,y=$(".file-name"),x=$(".modify-time"),k=$(".share-content"),T=$("#download-client-text"),C=$(".save-to-note"),E=$("#save-hint"),I=$("#main"),S=$(".file-icon-contianer"),D=$(".btn-download"),N=$(".read-text"),P=$(".size"),A=$(".account"),F=$(".name-drop"),M=F.find(".logout"),L=A.find(".name"),U=A.find("img"),O=$(".banner"),G=$(".loading"),R=$(".drop-list ul"),z=!1,B="2237",j=$("#ad-link");e(),YnoteLogin.check(function(e){var t=$(".banner-main");t.hide(),e?getCurrentUserInfo().then(function(e){w=!0,L.text(e.name),e.photo&&U.attr("src",e.photo),A.css("display","inline-block"),$(".banner-right").show(),t.show(),isYDocUser(e.userId).then(function(e){g=e.result})},function(){$(".banner-right").show(),t.show()}):(w=!1,A.hide(),$("#download-client").css("right","0px"),t.show(),$(".banner-right").show())}),M.click(function(){window._hmt.push(["_trackEvent","web","logout"]),$.get("/auth/reset",{app:"web"}).then(function(){w=!1,A.hide(),F.hide(),C.removeClass(DISBTN),$("#download-client").css("right","0px"),$("#note-save").hide()})}),T.click(function(){window._hmt.push(["_trackEvent","web","downloadClient"]),Y&&window._hmt.push(["_trackEvent","marketPush","mp-download","mp-download-"+X])});var X=getParameter("id"),H=getParameter("type"),K=location.hash.indexOf("auto")>-1,Y="true"==getParameter("marketpush"),q=$.templates("#remindTmpl");redirectToMobile(X,H),i(),X&&getFileMeta(X).done(function(e){
function n(e,t){$(".praise-times").text(t),$(".read-text").text(e)}function i(){$(".size-info-line").hide(),$(".size-container").hide(),$(".file-info-rt-line").css("left","10px"),$(".read-times-container").css("left","20px")}function s(e){getNoteContent(X).then(function(t){function o(){setTimeout(function(){i.length<1&&(i=e.contents().find("html")),i.find("#noteContent").length>0?(i.find("#noteContent").html(parseContent(q,t.content)),a(e.contents())):o()},1e3)}n(t.pv,t.pr);var i=e.contents().find("html");i.find("#noteContent").length>0?i.find("#noteContent").html(parseContent(q,t.content)):o(),i.find("a").attr("target","_blank"),i.find("img").load(function(){var t=$("body").outerHeight(),n=t-O.outerHeight()-40;$("#main-container").height(n),m&&$("#main").css("min-height",n+"px"),b||e.get(0).contentWindow.parentIFrame.size(i.find("#noteContent").height()+39)}),a(e.contents()),I.addClass("content"),G.hide()},function(){window.location.href="index.html?id="+X+"&type="+H+"&error=true"}).always(function(){b||e.iFrameResize({log:!1}),t()}),r(g),K&&(C.click(),location.hash=location.hash.replace("auto",""))}var g=e,v=new Date(g.modifyTime),w=e.name,T=e.name,E=$("a.report-text"),F=g.id;if(0!=e.isMultilevel&&/\./.test(w)||(g.domain=0,w+=".note",i()),0==g.domain&&(T=filterNoteSuffix(e.name)),y.text(T),y.attr("title",T),E.attr("target","_blank"),E.attr("href","/jubao?shareKey="+X+"&fid="+F+"&type="+H),E.click(function(){window._hmt.push(["_trackEvent","web","jubao"])}),document.title=w,$(".praise-icon").click(function(e){$(e.currentTarget).hasClass("already")||(window._hmt.push(["_trackEvent","web","praise"]),praiseClick(X).then(function(t){$(e.currentTarget).addClass("already"),$(".praise-times").text(t.pr)},function(){window._hmt.push(["_trackEvent","web","praise-fail"])}))}),isWebkit()&&g.coopEdit){var M={accountBtn:A,nameBtn:L,userPhoto:U,loadEl:G};I.addClass("collab"),t(),I.css("height","100%"),r(g),K&&(C.click(),location.hash=location.hash.replace("auto","")),editor({renderNote:function(e){getNoteContent(X).then(function(e){n(e.pv,e.pr)},function(){window.location.href="index.html?id="+X+"&type="+H+"&error=true"})},hasPwd:!1,shareKey:X,allEl:M})}else switch(g.domain){case 0:m=k.find(".content-container"),c=$('<iframe id="content-body" src="iframe.html"></iframe>').appendTo(m),c.load(s(c));break;case 1:getNoteContent(X).then(function(e){n(e.pv,e.pr);var i=getDownloadLink(X,g.id);if(D.attr("href",i),REGEXMAP.OFFICE.test(w)){p=$(".share-office .content-container"),S.append('<div class="file-icon '+getIconClass(w,"large")+'"></div>'),c=f=$('<iframe id="content-body"></iframe>').appendTo(p),I.addClass("office");var a=getPreviewLink(X,g.id);f.attr("src",a),G.hide(),t(),REGEXMAP.EXCEL.test(w)&&($("#main").addClass("excel-main"),$(".banner").addClass("excel-banner"))}else{S.append('<div class="file-icon '+getIconClass(w)+'"></div>');var s;h=$(".btn-preview"),h.hide(),G.hide(),REGEXMAP.IMAGE.test(w)?(z=!0,s=$("#img-download"),$('<img class="file-image" src="'+i+'"></img>').appendTo(s).load(t())):REGEXMAP.PDF.test(w)||REGEXMAP.TXT.test(w)?(s=$("#not-image"),o(F),h.click(function(){REGEXMAP.PDF.test(w)?window._hmt.push(["_trackEvent","web","preview","preview-pdf"]):REGEXMAP.TXT.test(w)&&window._hmt.push(["_trackEvent","web","preview","preview-txt"])}),s.append('<div class="file-icon not-preview '+getIconClass(w,"big")+'"></div>'),$(".share-download .file-name").css("max-width","470px")):(s=$("#not-image"),s.append('<div class="file-icon not-preview '+getIconClass(w,"big")+'"></div>'),$("#text-download").show()),l=$(".share-download .content-container"),u=$(".share-download"),d=u.find(".content-header"),I.addClass("download");var m=$(".file-image");m.length>0?m.one("load",t):I.ready(t)}r(g),K&&(C.click(),location.hash=location.hash.replace("auto",""))},function(e){window.location.href="index.html?id="+X+"&type="+H+"&error=true"})}N.text(g.pv),x.text(getTimeString(v)),P.text(getSizeString(g.size))}).fail(function(){window.location.href="index.html?id="+X+"&type="+H+"&error=true"}),$(window).resize(t),dropDownList(L,F),s()});